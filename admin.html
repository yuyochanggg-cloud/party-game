<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°¾ç‰™å¤§äº‚é¬¥ - ç¸½æ§å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-800 text-white min-h-screen p-6">

    <div class="max-w-4xl mx-auto">
        <div class="flex space-x-4 mb-8 border-b border-gray-600 pb-4">
            <button onclick="switchTab('rank')" id="tab-rank" class="px-4 py-2 bg-yellow-500 text-black font-bold rounded">ğŸ“Š å³æ™‚æ’è¡Œæ¦œ</button>
            <button onclick="switchTab('settings')" id="tab-settings" class="px-4 py-2 bg-gray-700 text-white font-bold rounded">âš™ï¸ é¡Œç›®è¨­å®š</button>
        </div>

        <div id="view-rank" class="block">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-yellow-400">ğŸ† æˆ°æ³ç¸½è¦½</h2>
                <button id="btn-clear-rank" class="text-sm bg-red-900 text-red-200 px-3 py-1 rounded hover:bg-red-800">æ¸…ç©ºæ’è¡Œæ¦œè³‡æ–™</button>
            </div>
            <div class="bg-gray-700 rounded-lg shadow-xl overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-900 text-gray-400 uppercase">
                        <tr>
                            <th class="p-4">åæ¬¡</th>
                            <th class="p-4">å§“å</th>
                            <th class="p-4">éƒ¨é–€</th>
                            <th class="p-4 text-right">åˆ†æ•¸</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body" class="divide-y divide-gray-600"></tbody>
                </table>
            </div>
        </div>

        <div id="view-settings" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-400">ğŸ“ è¨­å®š 5 é“é¡Œç›®</h2>
                <button id="btn-save-questions" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded shadow-lg text-lg flex items-center">
                    ğŸ’¾ å„²å­˜ä¸¦ç™¼å¸ƒ
                </button>
            </div>
            <div id="questions-form" class="space-y-8">
                <p class="text-gray-400 text-center py-10">æ­£åœ¨è®€å–ç¾æœ‰é¡Œç›®...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, getDocs, deleteDoc, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // âš ï¸ ä½ çš„ Config
        const firebaseConfig = {
            apiKey: "ä½ çš„_API_KEY",
            authDomain: "ls3cquiz.firebaseapp.com",
            projectId: "ls3cquiz",
            storageBucket: "ls3cquiz.firebasestorage.app",
            messagingSenderId: "297051924336",
            appId: "1:297051924336:web:4a601199a2f37611d311b5",
            measurementId: "G-FV1YCGQNYB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- åŠŸèƒ½ 1: æ’è¡Œæ¦œé‚è¼¯ ---
        const q = query(collection(db, "players"), orderBy("score", "desc"));
        onSnapshot(q, (snapshot) => {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = ""; 
            let rank = 1;
            snapshot.forEach((docSnap) => {
                const p = docSnap.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-4 text-xl">${rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : '#' + rank}</td>
                    <td class="p-4 font-bold">${p.name}</td>
                    <td class="p-4 text-gray-300">${p.org}</td>
                    <td class="p-4 text-right font-mono text-yellow-400 font-bold text-xl">${p.score}</td>
                `;
                tbody.appendChild(tr);
                rank++;
            });
        });

        document.getElementById('btn-clear-rank').addEventListener('click', async () => {
            if (!confirm("ç¢ºå®šæ¸…ç©ºæ’è¡Œæ¦œï¼Ÿç„¡æ³•å¾©åŸå–”ï¼")) return;
            const snapshot = await getDocs(collection(db, "players"));
            snapshot.forEach(async (d) => await deleteDoc(doc(db, "players", d.id)));
        });

        // --- åŠŸèƒ½ 2: é¡Œç›®è¨­å®šé‚è¼¯ ---
        
        // åˆå§‹åŒ–è¼‰å…¥é¡Œç›®
        async function loadQuestions() {
            const formContainer = document.getElementById('questions-form');
            formContainer.innerHTML = ""; // æ¸…ç©º

            // å¾é›²ç«¯æŠ“ç›®å‰çš„è¨­å®šï¼Œå¦‚æœæ²’æœ‰å°±ç”¨é è¨­ç©ºå€¼
            let currentData = [];
            try {
                const docSnap = await getDoc(doc(db, "game_settings", "quiz_data"));
                if (docSnap.exists()) {
                    currentData = docSnap.data().questions;
                }
            } catch (e) { console.error("è®€å–å¤±æ•—", e); }

            // ç”¢ç”Ÿ 5 å€‹é¡Œç›®çš„è¡¨å–®
            for (let i = 0; i < 5; i++) {
                const qData = currentData[i] || { q: "", options: ["", "", "", ""], ans: 0 };
                
                const div = document.createElement('div');
                div.className = "bg-gray-700 p-6 rounded border border-gray-600";
                div.innerHTML = `
                    <div class="flex justify-between mb-2">
                        <label class="font-bold text-yellow-400">é¡Œç›® ${i + 1}</label>
                    </div>
                    <input type="text" id="q-${i}" value="${qData.q}" class="w-full p-2 mb-4 bg-gray-900 border border-gray-500 rounded text-white" placeholder="è¼¸å…¥é¡Œç›®å…§å®¹...">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${[0, 1, 2, 3].map(optIdx => `
                            <div class="flex items-center space-x-2">
                                <input type="radio" name="ans-${i}" value="${optIdx}" ${qData.ans == optIdx ? 'checked' : ''} class="w-5 h-5 accent-green-500 cursor-pointer">
                                <input type="text" id="opt-${i}-${optIdx}" value="${qData.options[optIdx] || ''}" class="w-full p-2 bg-gray-800 border border-gray-600 rounded text-sm" placeholder="é¸é … ${optIdx + 1}">
                            </div>
                        `).join('')}
                    </div>
                `;
                formContainer.appendChild(div);
            }
        }

        // å„²å­˜é¡Œç›®
        document.getElementById('btn-save-questions').addEventListener('click', async () => {
            const newQuestions = [];
            for (let i = 0; i < 5; i++) {
                const qText = document.getElementById(`q-${i}`).value;
                const options = [
                    document.getElementById(`opt-${i}-0`).value,
                    document.getElementById(`opt-${i}-1`).value,
                    document.getElementById(`opt-${i}-2`).value,
                    document.getElementById(`opt-${i}-3`).value
                ];
                // æ‰¾å‡ºè¢«é¸ä¸­çš„ç­”æ¡ˆ radio
                const ansRadio = document.querySelector(`input[name="ans-${i}"]:checked`);
                const ans = ansRadio ? parseInt(ansRadio.value) : 0;

                newQuestions.push({ q: qText, options, ans });
            }

            // å­˜å…¥ Firestore
            try {
                await setDoc(doc(db, "game_settings", "quiz_data"), {
                    questions: newQuestions
                });
                alert("âœ… é¡Œç›®è¨­å®šå·²æ›´æ–°ï¼ç¾åœ¨ç©å®¶ç™»å…¥å°‡æœƒçœ‹åˆ°æ–°é¡Œç›®ã€‚");
            } catch (e) {
                console.error(e);
                alert("âŒ å„²å­˜å¤±æ•—");
            }
        });

        // é é¢åˆ‡æ›è…³æœ¬
        window.switchTab = (tabName) => {
            if (tabName === 'rank') {
                document.getElementById('view-rank').classList.remove('hidden');
                document.getElementById('view-settings').classList.add('hidden');
                document.getElementById('tab-rank').className = "px-4 py-2 bg-yellow-500 text-black font-bold rounded";
                document.getElementById('tab-settings').className = "px-4 py-2 bg-gray-700 text-white font-bold rounded";
            } else {
                document.getElementById('view-rank').classList.add('hidden');
                document.getElementById('view-settings').classList.remove('hidden');
                document.getElementById('tab-rank').className = "px-4 py-2 bg-gray-700 text-white font-bold rounded";
                document.getElementById('tab-settings').className = "px-4 py-2 bg-blue-500 text-white font-bold rounded";
                loadQuestions(); // åˆ‡æ›éä¾†æ™‚æ‰è®€å–
            }
        };
    </script>
</body>
</html>