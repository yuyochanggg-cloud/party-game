<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°¾ç‰™å¤§äº‚é¬¥ - ç¸½æ§å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-800 text-white min-h-screen p-6 font-sans">

    <div class="max-w-5xl mx-auto space-y-8">
        
        <div class="bg-gray-900 p-6 rounded-2xl border-2 border-gray-700 shadow-2xl flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 mb-2">ğŸš¦ éŠæˆ²ä¸»æ§å°</h2>
                <div id="status-indicator" class="flex items-center space-x-2 text-gray-400">
                    <span class="w-3 h-3 rounded-full bg-gray-500"></span>
                    <span>ç›®å‰ç‹€æ…‹ï¼šè®€å–ä¸­...</span>
                </div>
            </div>
            
            <div class="flex space-x-4">
                <button id="btn-reset-game" class="group relative px-6 py-3 font-bold text-white rounded-xl bg-gray-700 hover:bg-red-600 transition-all duration-300 shadow-lg border border-gray-600">
                    <span class="mr-2">â¹</span> é‡ç½®/æš«åœ
                    <div class="absolute -bottom-10 left-1/2 transform -translate-x-1/2 text-xs bg-black text-white px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">
                        è®“ç©å®¶å›åˆ°ç­‰å¾…ç•«é¢
                    </div>
                </button>

                <button id="btn-start-game" class="relative px-8 py-3 font-black text-black rounded-xl bg-gradient-to-r from-green-400 to-green-600 hover:from-green-300 hover:to-green-500 transform hover:scale-105 transition-all duration-200 shadow-[0_0_20px_rgba(74,222,128,0.5)] border-2 border-green-300">
                    <span class="mr-2 text-xl">â–¶ï¸</span> ç«‹å³é–‹å§‹
                </button>
            </div>
        </div>

        <div class="flex space-x-2 border-b border-gray-700 pb-1">
            <button onclick="switchTab('rank')" id="tab-rank" class="px-6 py-3 bg-yellow-500 text-black font-bold rounded-t-lg transition hover:bg-yellow-400">ğŸ“Š å³æ™‚æ’è¡Œæ¦œ</button>
            <button onclick="switchTab('settings')" id="tab-settings" class="px-6 py-3 bg-gray-700 text-gray-300 font-bold rounded-t-lg transition hover:bg-gray-600">âš™ï¸ é¡Œç›®è¨­å®š</button>
        </div>

        <div id="view-rank" class="block bg-gray-900 p-6 rounded-b-xl rounded-tr-xl shadow-xl min-h-[500px]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">ğŸ† æˆ°æ³ç¸½è¦½</h2>
                <button id="btn-clear-rank" class="text-sm bg-red-900/50 text-red-200 px-4 py-2 rounded hover:bg-red-800 border border-red-800 transition">âš ï¸ æ¸…ç©ºæ‰€æœ‰ç©å®¶è³‡æ–™</button>
            </div>
            <div class="bg-gray-800 rounded-xl overflow-hidden shadow-inner border border-gray-700">
                <table class="w-full text-left">
                    <thead class="bg-gray-950 text-gray-400 uppercase text-sm tracking-wider">
                        <tr>
                            <th class="p-4">åæ¬¡</th>
                            <th class="p-4">å§“å</th>
                            <th class="p-4">éƒ¨é–€</th>
                            <th class="p-4">æº–ç¢ºç‡</th>
                            <th class="p-4">Max Combo</th>
                            <th class="p-4 text-right">ç¸½åˆ†</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body" class="divide-y divide-gray-700 text-lg">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="view-settings" class="hidden bg-gray-900 p-6 rounded-b-xl rounded-tr-xl shadow-xl min-h-[500px]">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-gray-900 z-10 py-2 border-b border-gray-800">
                <h2 class="text-2xl font-bold text-blue-400">ğŸ“ è¨­å®š 5 é“é¡Œç›®</h2>
                <button id="btn-save-questions" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-full shadow-lg text-lg flex items-center transition transform hover:scale-105">
                    ğŸ’¾ å„²å­˜ä¸¦ç™¼å¸ƒ
                </button>
            </div>
            <div id="questions-form" class="space-y-8 pb-10">
                <p class="text-gray-400 text-center py-10 animate-pulse">æ­£åœ¨è®€å–é›²ç«¯é¡Œç›®...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, getDocs, deleteDoc, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // âš ï¸ ä½¿ç”¨ä½ æœ€æ–°çš„ Config (è«‹ç¢ºèª API Key æ˜¯å¦æ­£ç¢º)
        const firebaseConfig = {
            apiKey: "AIzaSyDkQV-3otX0Kber9gIcyom8aTfpnuJvbDk",
            authDomain: "ls3cquiz.firebaseapp.com",
            projectId: "ls3cquiz",
            storageBucket: "ls3cquiz.firebasestorage.app",
            messagingSenderId: "297051924336",
            appId: "1:297051924336:web:4a601199a2f37611d311b5",
            measurementId: "G-FV1YCGQNYB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ==========================================
        // 1. éŠæˆ²æ§åˆ¶é‚è¼¯ (æ ¸å¿ƒåŠŸèƒ½)
        // ==========================================
        const statusDiv = document.getElementById('status-indicator');

        // ç›£è½ç›®å‰ç‹€æ…‹ (è®“ Admin çŸ¥é“ç¾åœ¨æ˜¯ä¸æ˜¯é–‹å§‹äº†)
        onSnapshot(doc(db, "game_state", "control"), (docSnap) => {
            const status = docSnap.data()?.status || 'waiting';
            if(status === 'started') {
                statusDiv.innerHTML = `
                    <span class="w-3 h-3 rounded-full bg-green-500 animate-ping"></span>
                    <span class="text-green-400 font-bold ml-2">ğŸ”¥ éŠæˆ²é€²è¡Œä¸­ (Live)</span>
                `;
            } else {
                statusDiv.innerHTML = `
                    <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                    <span class="text-yellow-400 font-bold ml-2">â¸ ç­‰å¾…é–‹å§‹ (Waiting)</span>
                `;
            }
        });

        // æŒ‰éˆ•ï¼šé–‹å§‹éŠæˆ²
        document.getElementById('btn-start-game').addEventListener('click', async () => {
            if(!confirm("ç¢ºå®šè¦é–‹å§‹éŠæˆ²å—ï¼Ÿ\n\næ‰€æœ‰å·²ç™»å…¥ä¸¦åœåœ¨ã€Œæº–å‚™ä¸­ã€çš„ç©å®¶ï¼Œæ‰‹æ©Ÿå°‡æœƒç«‹åˆ»åŒæ­¥é€²å…¥ç¬¬ä¸€é¡Œï¼")) return;
            try {
                await setDoc(doc(db, "game_state", "control"), { status: 'started', timestamp: serverTimestamp() });
                // alert("ğŸš€ éŠæˆ²å·²å•Ÿå‹•ï¼"); // ç‚ºäº†æµæš¢åº¦ï¼Œå¯ä»¥æŠŠé€™å€‹è¨»è§£æ‰
            } catch(e) { console.error(e); alert("å•Ÿå‹•å¤±æ•—"); }
        });

        // æŒ‰éˆ•ï¼šé‡ç½®/æš«åœ
        document.getElementById('btn-reset-game').addEventListener('click', async () => {
            if(!confirm("âš ï¸ è­¦å‘Šï¼šç¢ºå®šè¦é‡ç½®å—ï¼Ÿ\n\né€™æœƒå¼·åˆ¶æŠŠæ‰€æœ‰æ­£åœ¨ç©çš„ç©å®¶è¸¢å›ã€Œæº–å‚™ç•«é¢ã€ã€‚\né€šå¸¸ç”¨æ–¼æ¸¬è©¦æˆ–çªç™¼ç‹€æ³é‡ä¾†ã€‚")) return;
            try {
                await setDoc(doc(db, "game_state", "control"), { status: 'waiting', timestamp: serverTimestamp() });
            } catch(e) { console.error(e); alert("é‡ç½®å¤±æ•—"); }
        });


// ==========================================
        // 2. æ’è¡Œæ¦œé‚è¼¯ (æ•ˆèƒ½å„ªåŒ–ç‰ˆï¼šæ¯ 1 ç§’æ›´æ–°ä¸€æ¬¡)
        // ==========================================
        const q = query(collection(db, "players"), orderBy("score", "desc"));
        
        let latestDocs = []; // ç”¨ä¾†æš«å­˜æœ€æ–°çš„è³‡æ–™
        let needsUpdate = false; // æ¨™è¨˜æ˜¯å¦éœ€è¦æ›´æ–°ç•«é¢

        // 1. ç›£è½å™¨åªè² è²¬ã€Œæ”¶è³‡æ–™ã€ï¼Œä¸åšã€Œç•«ç•«é¢ã€çš„è‹¦å·¥
        onSnapshot(q, (snapshot) => {
            latestDocs = snapshot.docs;
            needsUpdate = true;
        });

        // 2. è¨­å®šä¸€å€‹è¨ˆæ™‚å™¨ï¼Œæ¯ 1000 æ¯«ç§’ (1ç§’) æª¢æŸ¥ä¸€æ¬¡è¦ä¸è¦ç•«ç•«é¢
        // é€™æ¨£å¯ä»¥é¿å…ç€è¦½å™¨å› ç‚ºç¬é–“å¤ªå¤šè³‡æ–™è€Œç•¶æ©Ÿ
        setInterval(() => {
            if (needsUpdate) {
                renderLeaderboard(latestDocs);
                needsUpdate = false;
            }
        }, 1000);

        // ç¨ç«‹å‡ºä¾†çš„ç¹ªåœ–å‡½æ•¸
        function renderLeaderboard(docs) {
            const tbody = document.getElementById('leaderboard-body');
            // é€™è£¡ç”¨ä¸€å€‹å­—ä¸²ç´¯ç© HTMLï¼Œå†ä¸€æ¬¡å¯«å…¥ï¼Œæ•ˆèƒ½æœƒæ¯” appendChild æ›´å¿«
            let htmlContent = "";
            let rank = 1;

            docs.forEach((docSnap) => {
                const p = docSnap.data();
                
                // å‰ä¸‰åæ¨£å¼
                let rankDisplay = `<span class="font-mono text-gray-500">#${rank}</span>`;
                let rowClass = "";
                if (rank === 1) { rankDisplay = "ğŸ¥‡"; rowClass = "text-yellow-400 bg-yellow-900/10"; }
                if (rank === 2) { rankDisplay = "ğŸ¥ˆ"; rowClass = "text-gray-300"; }
                if (rank === 3) { rankDisplay = "ğŸ¥‰"; rowClass = "text-orange-400"; }

                htmlContent += `
                    <tr class="hover:bg-gray-800 transition border-b border-gray-700">
                        <td class="p-4 text-2xl">${rankDisplay}</td>
                        <td class="p-4 font-bold text-lg ${rowClass}">${p.name || '---'}</td>
                        <td class="p-4 text-gray-400">${p.org || '---'}</td>
                        <td class="p-4 font-mono text-blue-300">${p.accuracy ? p.accuracy + '%' : '-'}</td>
                        <td class="p-4 font-mono text-orange-400 font-bold">${p.maxCombo ? 'x' + p.maxCombo : '-'}</td>
                        <td class="p-4 text-right font-mono text-2xl font-black ${rank === 1 ? 'text-yellow-400' : 'text-white'}">${p.score?.toLocaleString() || 0}</td>
                    </tr>
                `;
                rank++;
            });

            tbody.innerHTML = htmlContent;
        }

        document.getElementById('btn-clear-rank').addEventListener('click', async () => {
            if (!confirm("ğŸ§¨ å±éšªæ“ä½œï¼šç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ç©å®¶ç´€éŒ„å—ï¼Ÿ\næ’è¡Œæ¦œå°‡æœƒæ¸…ç©ºï¼")) return;
            const snapshot = await getDocs(collection(db, "players"));
            snapshot.forEach(async (d) => await deleteDoc(doc(db, "players", d.id)));
        });


        // ==========================================
        // 3. é¡Œç›®è¨­å®šé‚è¼¯
        // ==========================================
        async function loadQuestions() {
            const formContainer = document.getElementById('questions-form');
            formContainer.innerHTML = ""; 

            let currentData = [];
            try {
                const docSnap = await getDoc(doc(db, "game_settings", "quiz_data"));
                if (docSnap.exists()) {
                    currentData = docSnap.data().questions;
                }
            } catch (e) { console.error("è®€å–å¤±æ•—", e); }

            for (let i = 0; i < 5; i++) {
                const qData = currentData[i] || { q: "", options: ["", "", "", ""], ans: 0, timeLimit: 20 };
                
                const div = document.createElement('div');
                div.className = "bg-gray-800 p-6 rounded-xl border border-gray-700 shadow-md relative group hover:border-blue-500 transition";
                div.innerHTML = `
                    <div class="flex justify-between mb-4">
                        <label class="font-bold text-xl text-yellow-400">Q${i + 1}</label>
                        <div class="flex items-center space-x-2">
                            <label class="text-xs text-gray-400">ç§’æ•¸è¨­å®š</label>
                            <input type="number" id="time-${i}" value="${qData.timeLimit || 20}" class="w-16 p-1 bg-gray-900 border border-gray-600 rounded text-center text-white" min="5" max="60">
                        </div>
                    </div>
                    <input type="text" id="q-${i}" value="${qData.q}" class="w-full p-3 mb-6 bg-gray-900 border border-gray-600 focus:border-blue-400 rounded-lg text-white text-lg font-bold placeholder-gray-600" placeholder="è«‹è¼¸å…¥é¡Œç›®...">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${[0, 1, 2, 3].map((optIdx, arrIdx) => `
                            <div class="flex items-center space-x-3 bg-gray-900/50 p-3 rounded-lg border border-gray-700 hover:bg-gray-900 transition">
                                <input type="radio" name="ans-${i}" value="${optIdx}" ${qData.ans == optIdx ? 'checked' : ''} class="w-6 h-6 accent-green-500 cursor-pointer">
                                <span class="font-mono text-gray-500 font-bold">${String.fromCharCode(65+arrIdx)}.</span>
                                <input type="text" id="opt-${i}-${optIdx}" value="${qData.options[optIdx] || ''}" class="w-full p-2 bg-transparent border-b border-gray-600 focus:border-yellow-400 outline-none text-white transition" placeholder="é¸é … ${String.fromCharCode(65+arrIdx)}">
                            </div>
                        `).join('')}
                    </div>
                `;
                formContainer.appendChild(div);
            }
        }

        document.getElementById('btn-save-questions').addEventListener('click', async () => {
            const newQuestions = [];
            for (let i = 0; i < 5; i++) {
                const qText = document.getElementById(`q-${i}`).value;
                const timeLimit = parseInt(document.getElementById(`time-${i}`).value) || 20;
                const options = [
                    document.getElementById(`opt-${i}-0`).value,
                    document.getElementById(`opt-${i}-1`).value,
                    document.getElementById(`opt-${i}-2`).value,
                    document.getElementById(`opt-${i}-3`).value
                ];
                const ansRadio = document.querySelector(`input[name="ans-${i}"]:checked`);
                const ans = ansRadio ? parseInt(ansRadio.value) : 0;

                newQuestions.push({ q: qText, options, ans, timeLimit });
            }

            try {
                await setDoc(doc(db, "game_settings", "quiz_data"), { questions: newQuestions });
                alert("âœ… é¡Œç›®ç™¼å¸ƒæˆåŠŸï¼\n\nè«‹ç¢ºèªï¼š\n1. ç©å®¶å·²ç™»å…¥ä¸¦åœ¨ã€Œæº–å‚™ç•«é¢ã€\n2. æº–å‚™å¥½å¾ŒæŒ‰ä¸Šæ–¹ã€Œç«‹å³é–‹å§‹ã€");
            } catch (e) { console.error(e); alert("âŒ å„²å­˜å¤±æ•—"); }
        });

        // é é¢åˆ‡æ›
        window.switchTab = (tabName) => {
            if (tabName === 'rank') {
                document.getElementById('view-rank').classList.remove('hidden');
                document.getElementById('view-settings').classList.add('hidden');
                document.getElementById('tab-rank').className = "px-6 py-3 bg-yellow-500 text-black font-bold rounded-t-lg shadow-[0_-5px_15px_rgba(234,179,8,0.2)] z-10 relative";
                document.getElementById('tab-settings').className = "px-6 py-3 bg-gray-800 text-gray-400 font-bold rounded-t-lg border-b border-gray-700 hover:bg-gray-700 transition";
            } else {
                document.getElementById('view-rank').classList.add('hidden');
                document.getElementById('view-settings').classList.remove('hidden');
                document.getElementById('tab-rank').className = "px-6 py-3 bg-gray-800 text-gray-400 font-bold rounded-t-lg border-b border-gray-700 hover:bg-gray-700 transition";
                document.getElementById('tab-settings').className = "px-6 py-3 bg-blue-600 text-white font-bold rounded-t-lg shadow-[0_-5px_15px_rgba(37,99,235,0.3)] z-10 relative";
                loadQuestions();
            }
        };
    </script>
</body>
</html>