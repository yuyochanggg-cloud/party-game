<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°¾ç‰™å¤§äº‚é¬¥ - æŒ‘æˆ°è€…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å‹•ç•«æ•ˆæœå®šç¾© */
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .floating { animation: float 3s ease-in-out infinite; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4 select-none overflow-hidden">

    <div id="login-section" class="w-full max-w-md space-y-4 pop-in">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 mb-2">ğŸ”¥ å°¾ç‰™å¤§äº‚é¬¥</h1>
            <p class="text-gray-400 text-sm">é€Ÿåº¦æ±ºå®šå‹è²  Â· é€£æ“Šå‰µé€ å‚³å¥‡</p>
        </div>
        <input type="text" id="input-name" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" class="w-full p-4 rounded-xl bg-gray-800 border-2 border-gray-700 focus:border-yellow-400 focus:bg-gray-700 outline-none transition text-lg font-bold text-center placeholder-gray-500 text-white">
        <input type="text" id="input-org" placeholder="éƒ¨é–€ / å–®ä½" class="w-full p-4 rounded-xl bg-gray-800 border-2 border-gray-700 focus:border-yellow-400 focus:bg-gray-700 outline-none transition text-lg font-bold text-center placeholder-gray-500 text-white">
        <button id="btn-join" class="w-full bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-400 hover:to-orange-500 text-black font-black py-4 rounded-xl text-xl shadow-lg transform active:scale-95 transition">æº–å‚™å…¥å ´</button>
    </div>

    <div id="loading-section" class="hidden text-center">
        <div class="w-16 h-16 border-4 border-yellow-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <div class="text-xl font-bold text-yellow-400 animate-pulse">æ­£åœ¨é€£ç·šä¼ºæœå™¨...</div>
    </div>

    <div id="wait-start-section" class="hidden w-full max-w-md text-center pop-in">
        <div class="mb-8 relative flex justify-center">
            <div class="absolute inset-0 bg-yellow-500 blur-3xl opacity-20 animate-pulse"></div>
            <div class="text-8xl relative z-10 floating">â³</div>
        </div>
        <h2 class="text-4xl font-black text-white mb-2 tracking-wider">READY?</h2>
        <p class="text-gray-400 mb-8 animate-pulse font-mono">WAITING FOR HOST TO START...</p>
        
        <div class="bg-gray-800/50 backdrop-blur border border-gray-700 p-6 rounded-2xl mx-4 shadow-2xl transform rotate-1 hover:rotate-0 transition duration-500">
            <p class="text-xs text-gray-500 font-mono mb-2 tracking-widest">PLAYER PROFILE</p>
            <p class="text-3xl font-bold text-yellow-400" id="display-name">---</p>
            <p class="text-sm text-gray-400 mt-1" id="display-org">---</p>
            
            <div class="mt-6 flex justify-center space-x-2">
                <span class="w-3 h-3 bg-yellow-500 rounded-full animate-bounce" style="animation-delay: 0s"></span>
                <span class="w-3 h-3 bg-yellow-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
                <span class="w-3 h-3 bg-yellow-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
            </div>
        </div>
        <p class="text-xs text-gray-600 mt-8">è«‹ä¿æŒè¢å¹•é–‹å•Ÿï¼Œä¸è¦é—œé–‰è¦–çª—</p>
    </div>

    <div id="game-section" class="hidden w-full max-w-md relative pop-in">
        <div class="flex justify-between items-end mb-3 px-2">
            <div class="text-left">
                <div class="text-xs text-gray-500 font-mono font-bold">SCORE</div>
                <div id="current-score" class="text-3xl font-black text-yellow-400 font-mono tracking-tight" style="text-shadow: 0 0 10px rgba(250, 204, 21, 0.5);">0</div>
            </div>
            <div class="text-right">
                <div class="text-xs text-gray-500 font-mono font-bold">COMBO</div>
                <div id="combo-display" class="text-3xl font-black text-gray-600 font-mono italic transition-all duration-200">x0</div>
            </div>
        </div>

        <div class="w-full h-4 bg-gray-800 rounded-full mb-6 overflow-hidden border border-gray-700 shadow-inner relative">
            <div id="timer-bar" class="h-full bg-gradient-to-r from-green-400 to-blue-500 w-full transition-all duration-100 ease-linear shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>
        </div>

        <div class="bg-gray-800/80 backdrop-blur-md rounded-2xl p-6 mb-6 border border-gray-600 shadow-2xl min-h-[160px] flex flex-col justify-center relative overflow-hidden group">
            <div class="absolute top-0 right-0 bg-yellow-500 text-black text-xs font-bold px-3 py-1 rounded-bl-xl font-mono" id="question-counter">Q1</div>
            <h2 id="question-text" class="text-xl md:text-2xl font-bold text-center leading-relaxed text-gray-100">é¡Œç›®è¼‰å…¥ä¸­...</h2>
        </div>

        <div id="options-container" class="grid grid-cols-1 gap-3 pb-8"></div>
    </div>

    <div id="feedback-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm pop-in">
        <div id="feedback-content" class="text-center transform scale-110">
            </div>
    </div>

    <div id="result-section" class="hidden w-full max-w-md text-center pop-in">
        <div class="mb-4 text-8xl floating">ğŸ†</div>
        <h2 class="text-4xl font-black mb-2 text-white tracking-wide">CHALLENGE<br>COMPLETE</h2>
        <p class="text-gray-400 mb-8 font-mono text-sm">è«‹çœ‹å¤§è¢å¹•å…¬å¸ƒæ’å</p>
        
        <div class="bg-gray-800/80 backdrop-blur rounded-3xl p-8 border border-gray-700 shadow-2xl transform transition hover:scale-105 duration-300">
            <div class="text-sm text-gray-500 mb-1 font-mono tracking-widest">FINAL SCORE</div>
            <div class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600 mb-8 font-mono tracking-tighter" id="final-score">0</div>
            
            <div class="grid grid-cols-2 gap-6 border-t border-gray-700 pt-6">
                <div>
                    <div class="text-xs text-gray-500 font-bold mb-1">MAX COMBO</div>
                    <div class="text-2xl font-black text-orange-400" id="final-combo">0</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500 font-bold mb-1">ACCURACY</div>
                    <div class="text-2xl font-black text-blue-400" id="final-accuracy">0%</div>
                </div>
            </div>
        </div>
        
        <div class="mt-8 flex items-center justify-center gap-2 text-green-500 font-mono text-xs opacity-80">
            <span class="relative flex h-3 w-3">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
            </span>
            DATA UPLOADED TO CLOUD
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // === Firebase Config ===
        const firebaseConfig = {
            apiKey: "AIzaSyDkQV-3otX0Kber9gIcyom8aTfpnuJvbDk",
            authDomain: "ls3cquiz.firebaseapp.com",
            projectId: "ls3cquiz",
            storageBucket: "ls3cquiz.firebasestorage.app",
            messagingSenderId: "297051924336",
            appId: "1:297051924336:web:4a601199a2f37611d311b5",
            measurementId: "G-FV1YCGQNYB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // === éŠæˆ²å…¨åŸŸè®Šæ•¸ ===
        let questions = [];
        let currentUser = null;
        let currentQIndex = 0;
        
        let totalScore = 0;
        let currentCombo = 0;
        let maxCombo = 0;
        let correctCount = 0;

        let timerInterval = null;
        let questionStartTime = 0;
        const DEFAULT_TIME_LIMIT = 20;
        let questionTimeLimit = DEFAULT_TIME_LIMIT;

        // === DOM å…ƒç´  ===
        const els = {
            login: document.getElementById('login-section'),
            loading: document.getElementById('loading-section'),
            wait: document.getElementById('wait-start-section'),
            game: document.getElementById('game-section'),
            result: document.getElementById('result-section'),
            feedback: document.getElementById('feedback-overlay'),
            timerBar: document.getElementById('timer-bar'),
            score: document.getElementById('current-score'),
            combo: document.getElementById('combo-display')
        };

        // === 1. åˆå§‹åŒ– & ç™»å…¥ ===
        document.getElementById('btn-join').addEventListener('click', async () => {
            const name = document.getElementById('input-name').value.trim();
            const org = document.getElementById('input-org').value.trim();
            if (!name) return alert("è«‹è¼¸å…¥çœŸå¯¦å§“åä»¥åˆ©é ˜çï¼");

            try {
                // è½‰å ´ï¼šé¡¯ç¤ºè¼‰å…¥ä¸­
                els.login.classList.add('hidden');
                els.loading.classList.remove('hidden');

                // Firebase åŒ¿åç™»å…¥
                const userCred = await signInAnonymously(auth);
                currentUser = { uid: userCred.user.uid, name, org };

                // æ›´æ–°ç­‰å¾…ç•«é¢è³‡è¨Š
                document.getElementById('display-name').innerText = name;
                document.getElementById('display-org').innerText = org || 'åƒè³½è€…';

                // é å…ˆä¸‹è¼‰é¡Œç›® (é‡é»ï¼šå…ˆæŠ“ä¸‹ä¾†ä½†ä¸é–‹å§‹)
                const docSnap = await getDoc(doc(db, "game_settings", "quiz_data"));
                if (docSnap.exists() && docSnap.data().questions) {
                    questions = docSnap.data().questions;
                } else {
                    alert("å¾Œå°å°šæœªè¨­å®šé¡Œç›®ï¼è«‹é€šçŸ¥ä¸»æŒäººã€‚");
                    location.reload();
                    return;
                }

                // åœ¨å¾Œå°è¨»å†Šç©å®¶ç‹€æ…‹ï¼šwaiting_start
                await setDoc(doc(db, "players", currentUser.uid), {
                    name, org, score: 0, status: "waiting_start", timestamp: serverTimestamp()
                });

                // è½‰å ´ï¼šé€²å…¥ç­‰å¾…ç•«é¢
                els.loading.classList.add('hidden');
                els.wait.classList.remove('hidden');

                // é–‹å§‹ç›£è½ä¸»æŒäººä¿¡è™Ÿ
                listenForGameStart();

            } catch (e) {
                console.error(e);
                alert("é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†");
                location.reload();
            }
        });

        // === 2. ç›£è½ä¸»æŒäººæ§åˆ¶ä¿¡è™Ÿ ===
        function listenForGameStart() {
            onSnapshot(doc(db, "game_state", "control"), (docSnap) => {
                const status = docSnap.data()?.status;

                // ç‹€æ³ A: ä¸»æŒäººæŒ‰é–‹å§‹ + æˆ‘åœ¨ç­‰å¾…ç•«é¢ => è¡å•Šï¼
                if (status === 'started' && !els.wait.classList.contains('hidden')) {
                    els.wait.classList.add('hidden');
                    els.game.classList.remove('hidden');
                    loadQuestion(); // æ­£å¼é€²å…¥ç¬¬ä¸€é¡Œ
                }
                
                // ç‹€æ³ B: ä¸»æŒäººæŒ‰é‡ç½® + æˆ‘æ­£åœ¨ç© => å¼·åˆ¶é‡æ•´
                if (status === 'waiting' && !els.game.classList.contains('hidden')) {
                    location.reload();
                }
            });
        }

        // === 3. è¼‰å…¥é¡Œç›®é‚è¼¯ ===
        function loadQuestion() {
            if (currentQIndex >= questions.length) {
                finishGame();
                return;
            }

            const q = questions[currentQIndex];
            
            // è¨­å®šæ–‡å­—
            document.getElementById('question-text').innerText = q.q || "é¡Œç›®";
            document.getElementById('question-counter').innerText = `Q${currentQIndex + 1} / ${questions.length}`;
            
            // å»ºç«‹é¸é …
            const optsDiv = document.getElementById('options-container');
            optsDiv.innerHTML = "";
            const opts = q.options || ["A", "B", "C", "D"];
            
            opts.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full bg-gray-700 hover:bg-gray-600 active:bg-gray-500 text-white font-bold py-4 px-6 rounded-xl transition-all duration-100 text-left text-lg shadow-lg border-b-4 border-gray-800 active:border-b-0 active:translate-y-1 relative overflow-hidden group";
                btn.innerHTML = `<span class="opacity-50 mr-3 font-mono text-yellow-500">${String.fromCharCode(65+idx)}.</span>${opt}`;
                btn.onclick = (e) => handleAnswer(idx, e.target);
                optsDiv.appendChild(btn);
            });

            // é–‹å§‹å€’æ•¸
            questionTimeLimit = q.timeLimit || DEFAULT_TIME_LIMIT;
            startTimer();
        }

        // === 4. è¨ˆæ™‚å™¨é‚è¼¯ ===
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            questionStartTime = Date.now();
            
            // é‡ç½® Bar é¡è‰²
            els.timerBar.style.width = '100%';
            els.timerBar.className = 'h-full w-full transition-all duration-100 ease-linear bg-gradient-to-r from-green-400 to-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.5)]';

            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - questionStartTime) / 1000;
                const remaining = Math.max(0, questionTimeLimit - elapsed);
                const percent = (remaining / questionTimeLimit) * 100;

                els.timerBar.style.width = `${percent}%`;

                // å‰© 30% è®Šç´… + ç™¼å…‰
                if (percent < 30) {
                    els.timerBar.className = 'h-full w-full transition-all duration-100 ease-linear bg-red-500 shadow-[0_0_15px_rgba(239,68,68,0.8)]';
                }

                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    handleAnswer(-1, null); // è¶…æ™‚
                }
            }, 100);
        }

        // === 5. è™•ç†ä½œç­” (æ ¸å¿ƒè¨ˆåˆ†) ===
        function handleAnswer(selectedIndex, btnElement) {
            clearInterval(timerInterval);
            
            // é–å®šæŒ‰éˆ•
            const allBtns = document.querySelectorAll('#options-container button');
            allBtns.forEach(b => b.disabled = true);

            // åˆ¤æ–·å°éŒ¯
            const correctAns = parseInt(questions[currentQIndex].ans);
            const isCorrect = selectedIndex === correctAns;
            
            // è¨ˆç®—åˆ†æ•¸
            const timeTaken = (Date.now() - questionStartTime) / 1000;
            const timeLeft = Math.max(0, questionTimeLimit - timeTaken);
            let roundScore = 0;
            
            if (isCorrect) {
                // å…¬å¼ï¼š(åŸºç¤åˆ† + é€Ÿåº¦çå‹µ) * é€£æ“Šå€ç‡
                const basePoints = 500;
                const timeRatio = timeLeft / questionTimeLimit;
                const speedBonus = Math.round(1000 * Math.pow(timeRatio, 1.5)); // é€Ÿåº¦è¶Šå¿«åˆ†è¶Šé«˜
                
                currentCombo++;
                if (currentCombo > maxCombo) maxCombo = currentCombo;
                const streakMultiplier = 1 + (currentCombo * 0.1); // æ¯å€‹ Combo +10%
                
                roundScore = Math.round((basePoints + speedBonus) * streakMultiplier);
                totalScore += roundScore;
                correctCount++;

                // é¡¯ç¤º Combo ç«ç„°ç‰¹æ•ˆ
                els.combo.innerHTML = `<span class="text-orange-500 animate-pulse drop-shadow-[0_0_5px_rgba(249,115,22,0.8)]">ğŸ”¥ x${currentCombo}</span>`;
                els.combo.classList.add('scale-125');
            } else {
                currentCombo = 0;
                els.combo.innerText = "x0";
                els.combo.classList.remove('scale-125');
            }

            // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
            els.score.innerText = totalScore.toLocaleString();

            // é¡¯ç¤ºå›é¥‹ (Overlay)
            showFeedback(isCorrect, roundScore);

            // 2ç§’å¾Œä¸‹ä¸€é¡Œ
            setTimeout(() => {
                els.feedback.classList.add('hidden');
                currentQIndex++;
                loadQuestion();
            }, 2000);
        }

        // === 6. é¡¯ç¤ºå›é¥‹å½ˆçª— ===
        function showFeedback(isCorrect, scoreEarned) {
            const content = document.getElementById('feedback-content');
            els.feedback.classList.remove('hidden');
            
            if (isCorrect) {
                content.innerHTML = `
                    <div class="text-9xl mb-4 animate-bounce">âœ…</div>
                    <div class="text-5xl font-black text-green-400 mb-2 drop-shadow-lg">NICE!</div>
                    <div class="text-3xl text-white font-mono font-bold">+${scoreEarned}</div>
                    ${currentCombo > 1 ? `<div class="text-orange-400 font-bold mt-4 text-xl animate-pulse">é€£æ“Š x${currentCombo}</div>` : ''}
                `;
            } else {
                content.innerHTML = `
                    <div class="text-9xl mb-4 animate-shake">âŒ</div>
                    <div class="text-5xl font-black text-red-500 mb-2 drop-shadow-lg">OOPS!</div>
                    <div class="text-gray-400 font-mono mt-2">Combo Reset</div>
                `;
            }
        }

        // === 7. éŠæˆ²çµæŸ & ä¸Šå‚³ ===
        async function finishGame() {
            els.game.classList.add('hidden');
            els.result.classList.remove('hidden');
            
            document.getElementById('final-score').innerText = totalScore.toLocaleString();
            document.getElementById('final-combo').innerText = maxCombo;
            const accuracy = Math.round((correctCount / questions.length) * 100);
            document.getElementById('final-accuracy').innerText = `${accuracy}%`;

            try {
                await setDoc(doc(db, "players", currentUser.uid), {
                    name: currentUser.name,
                    org: currentUser.org,
                    score: totalScore,
                    maxCombo: maxCombo,
                    accuracy: accuracy,
                    status: "finished",
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error("Upload failed", e);
            }
        }
    </script>
</body>
</html>