<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°¾ç‰™å¤§äº‚é¬¥ - æŒ‘æˆ°è€…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ç°¡å–®çš„å‹•ç•«æ•ˆæœ */
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4 select-none">

    <div id="login-section" class="w-full max-w-md space-y-4">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 mb-2">ğŸ”¥ å°¾ç‰™å¤§äº‚é¬¥</h1>
            <p class="text-gray-400 text-sm">é€Ÿåº¦æ±ºå®šå‹è²  Â· é€£æ“Šå‰µé€ å‚³å¥‡</p>
        </div>
        <input type="text" id="input-name" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å" class="w-full p-4 rounded-xl bg-gray-800 border-2 border-gray-700 focus:border-yellow-400 focus:bg-gray-700 outline-none transition text-lg font-bold text-center">
        <input type="text" id="input-org" placeholder="éƒ¨é–€ / å–®ä½" class="w-full p-4 rounded-xl bg-gray-800 border-2 border-gray-700 focus:border-yellow-400 focus:bg-gray-700 outline-none transition text-lg font-bold text-center">
        <button id="btn-join" class="w-full bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-400 hover:to-orange-500 text-black font-black py-4 rounded-xl text-xl shadow-lg transform active:scale-95 transition">é–‹å§‹æŒ‘æˆ°</button>
    </div>

    <div id="loading-section" class="hidden text-center">
        <div class="w-16 h-16 border-4 border-yellow-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <div class="text-xl font-bold text-yellow-400 animate-pulse">æ­£åœ¨ä¸‹è¼‰é¡Œç›®å·...</div>
    </div>

    <div id="game-section" class="hidden w-full max-w-md relative">
        <div class="flex justify-between items-end mb-2 px-2">
            <div class="text-left">
                <div class="text-xs text-gray-500 font-mono">SCORE</div>
                <div id="current-score" class="text-2xl font-black text-yellow-400 font-mono">0</div>
            </div>
            <div class="text-right">
                <div class="text-xs text-gray-500 font-mono">COMBO</div>
                <div id="combo-display" class="text-2xl font-black text-gray-600 font-mono">x0</div>
            </div>
        </div>

        <div class="w-full h-3 bg-gray-800 rounded-full mb-6 overflow-hidden">
            <div id="timer-bar" class="h-full bg-gradient-to-r from-green-400 to-blue-500 w-full transition-all duration-100 ease-linear"></div>
        </div>

        <div class="bg-gray-800/50 backdrop-blur rounded-2xl p-6 mb-6 border border-gray-700 shadow-xl min-h-[140px] flex flex-col justify-center relative overflow-hidden">
            <span id="question-counter" class="absolute top-2 right-4 text-xs bg-gray-900 px-2 py-1 rounded text-gray-400">Q1</span>
            <h2 id="question-text" class="text-xl md:text-2xl font-bold text-center leading-relaxed">é¡Œç›®è¼‰å…¥ä¸­...</h2>
        </div>

        <div id="options-container" class="grid grid-cols-1 gap-3"></div>
    </div>

    <div id="feedback-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm pop-in">
        <div id="feedback-content" class="text-center transform scale-110">
            </div>
    </div>

    <div id="result-section" class="hidden w-full max-w-md text-center pop-in">
        <div class="mb-6 text-6xl">ğŸ†</div>
        <h2 class="text-3xl font-bold mb-2 text-white">æŒ‘æˆ°å®Œæˆï¼</h2>
        <p class="text-gray-400 mb-8">è«‹ä¿æŒç•«é¢ï¼Œç­‰å¾…ä¸»æŒäººå…¬å¸ƒæ’å</p>
        
        <div class="bg-gray-800 rounded-2xl p-8 border border-gray-700 shadow-2xl">
            <div class="text-sm text-gray-500 mb-1 font-mono">FINAL SCORE</div>
            <div class="text-6xl font-black text-yellow-400 mb-6 font-mono tracking-tighter" id="final-score">0</div>
            
            <div class="grid grid-cols-2 gap-4 border-t border-gray-700 pt-6">
                <div>
                    <div class="text-xs text-gray-500">MAX COMBO</div>
                    <div class="text-xl font-bold text-orange-400" id="final-combo">0</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">ACCURACY</div>
                    <div class="text-xl font-bold text-blue-400" id="final-accuracy">0%</div>
                </div>
            </div>
        </div>
        
        <div class="mt-8 text-sm text-green-500 animate-pulse font-mono flex items-center justify-center gap-2">
            <span class="w-2 h-2 bg-green-500 rounded-full"></span> 
            æ•¸æ“šå·²åŒæ­¥è‡³é›²ç«¯
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // === ä½ çš„ Firebase Config ===
        const firebaseConfig = {
            apiKey: "AIzaSyDkQV-3otX0Kber9gIcyom8aTfpnuJvbDk",
            authDomain: "ls3cquiz.firebaseapp.com",
            projectId: "ls3cquiz",
            storageBucket: "ls3cquiz.firebasestorage.app",
            messagingSenderId: "297051924336",
            appId: "1:297051924336:web:4a601199a2f37611d311b5",
            measurementId: "G-FV1YCGQNYB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // === éŠæˆ²å…¨åŸŸè®Šæ•¸ ===
        let questions = [];
        let currentUser = null;
        let currentQIndex = 0;
        
        // è¨ˆåˆ†ç›¸é—œè®Šæ•¸
        let totalScore = 0;
        let currentCombo = 0;
        let maxCombo = 0;
        let correctCount = 0;

        // è¨ˆæ™‚ç›¸é—œè®Šæ•¸
        let timerInterval = null;
        let questionStartTime = 0;
        const DEFAULT_TIME_LIMIT = 20; // é è¨­æ¯é¡Œ 20 ç§’
        let questionTimeLimit = DEFAULT_TIME_LIMIT;

        // === DOM å…ƒç´  ===
        const els = {
            login: document.getElementById('login-section'),
            loading: document.getElementById('loading-section'),
            game: document.getElementById('game-section'),
            result: document.getElementById('result-section'),
            feedback: document.getElementById('feedback-overlay'),
            timerBar: document.getElementById('timer-bar'),
            score: document.getElementById('current-score'),
            combo: document.getElementById('combo-display')
        };

        // === 1. åˆå§‹åŒ–ç›£è½ ===
        document.getElementById('btn-join').addEventListener('click', async () => {
            const name = document.getElementById('input-name').value.trim();
            const org = document.getElementById('input-org').value.trim();
            if (!name) return alert("è«‹è¼¸å…¥çœŸå¯¦å§“åä»¥åˆ©é ˜çï¼");

            try {
                // ç™»å…¥å‹•ç•«
                els.login.classList.add('hidden');
                els.loading.classList.remove('hidden');

                // Firebase åŒ¿åç™»å…¥
                const userCred = await signInAnonymously(auth);
                currentUser = { uid: userCred.user.uid, name, org };

                // æŠ“å–é¡Œç›®
                const docSnap = await getDoc(doc(db, "game_settings", "quiz_data"));
                
                if (docSnap.exists() && docSnap.data().questions) {
                    questions = docSnap.data().questions;
                } else {
                    alert("ç›®å‰å¾Œå°é‚„æ²’æœ‰è¨­å®šé¡Œç›®å–”ï¼");
                    location.reload();
                    return;
                }

                // è¨»å†Šç©å®¶ç‹€æ…‹
                await setDoc(doc(db, "players", currentUser.uid), {
                    name, org, score: 0, status: "playing", timestamp: serverTimestamp()
                });

                // é–‹å§‹éŠæˆ²
                els.loading.classList.add('hidden');
                els.game.classList.remove('hidden');
                loadQuestion();

            } catch (e) {
                console.error(e);
                alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
                location.reload();
            }
        });

        // === 2. è¼‰å…¥é¡Œç›®é‚è¼¯ ===
        function loadQuestion() {
            if (currentQIndex >= questions.length) {
                finishGame();
                return;
            }

            const q = questions[currentQIndex];
            
            // è¨­å®š UI
            document.getElementById('question-text').innerText = q.q || "é¡Œç›®";
            document.getElementById('question-counter').innerText = `Q${currentQIndex + 1} / ${questions.length}`;
            
            // å»ºç«‹é¸é …æŒ‰éˆ•
            const optsDiv = document.getElementById('options-container');
            optsDiv.innerHTML = "";
            const opts = q.options || ["A", "B", "C", "D"];
            
            opts.forEach((opt, idx) => {
                const btn = document.createElement('button');
                // ç‚ºäº†é˜²æ­¢é‡è¤‡é»æ“Šï¼ŒåŠ ä¸Š pointer-events-auto
                btn.className = "w-full bg-gray-700 hover:bg-gray-600 active:bg-gray-500 text-white font-bold py-4 px-6 rounded-xl transition text-left text-lg shadow-md border-b-4 border-gray-900 active:border-b-0 active:translate-y-1 relative overflow-hidden group";
                btn.innerHTML = `<span class="opacity-50 mr-2 text-sm font-mono">${idx + 1}.</span> ${opt}`;
                
                // é»æ“Šäº‹ä»¶
                btn.onclick = (e) => handleAnswer(idx, e.target);
                optsDiv.appendChild(btn);
            });

            // é‡ç½®è¨ˆæ™‚å™¨
            questionTimeLimit = q.timeLimit || DEFAULT_TIME_LIMIT;
            startTimer();
        }

        // === 3. è¨ˆæ™‚å™¨é‚è¼¯ ===
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            questionStartTime = Date.now();
            
            // æ›´æ–°é€²åº¦æ¢å‹•ç•«
            els.timerBar.style.width = '100%';
            els.timerBar.className = 'h-full w-full transition-all duration-100 ease-linear bg-gradient-to-r from-green-400 to-blue-500';

            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - questionStartTime) / 1000;
                const remaining = Math.max(0, questionTimeLimit - elapsed);
                const percent = (remaining / questionTimeLimit) * 100;

                els.timerBar.style.width = `${percent}%`;

                // è®Šè‰²è­¦å‘Š
                if (percent < 30) {
                    els.timerBar.className = 'h-full w-full transition-all duration-100 ease-linear bg-red-500';
                }

                // æ™‚é–“åˆ°
                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    handleAnswer(-1, null); // -1 ä»£è¡¨è¶…æ™‚/ç­”éŒ¯
                }
            }, 100);
        }

        // === 4. ç­”é¡Œèˆ‡è¨ˆåˆ†æ ¸å¿ƒ (é‡é»!!) ===
        function handleAnswer(selectedIndex, btnElement) {
            clearInterval(timerInterval); // åœæ­¢è¨ˆæ™‚
            
            // é–å®šæ‰€æœ‰æŒ‰éˆ•é˜²æ­¢é€£é»
            const allBtns = document.querySelectorAll('#options-container button');
            allBtns.forEach(b => b.disabled = true);

            // åˆ¤æ–·å°éŒ¯
            const correctAns = parseInt(questions[currentQIndex].ans);
            const isCorrect = selectedIndex === correctAns;
            
            // è¨ˆç®—æ¶ˆè€—æ™‚é–“
            const timeTaken = (Date.now() - questionStartTime) / 1000;
            const timeLeft = Math.max(0, questionTimeLimit - timeTaken);

            // --- Kahoot æŒ‡æ•¸å‹è¨ˆåˆ†å…¬å¼ ---
            let roundScore = 0;
            
            if (isCorrect) {
                // 1. åŸºç¤åˆ†
                const basePoints = 500;
                
                // 2. é€Ÿåº¦çå‹µ (å‰©é¤˜æ™‚é–“è¶Šå¤šï¼Œåˆ†æ•¸è¶Šé«˜ï¼Œå¹³æ–¹æ›²ç·šè®“å¿«æ‰‹æ‹¿æ›´å¤š)
                const timeRatio = timeLeft / questionTimeLimit;
                const speedBonus = Math.round(1000 * Math.pow(timeRatio, 1.5));
                
                // 3. é€£æ“ŠåŠ æˆ (Combo è¶Šé«˜ï¼Œå€ç‡è¶Šé«˜)
                currentCombo++;
                if (currentCombo > maxCombo) maxCombo = currentCombo;
                const streakMultiplier = 1 + (currentCombo * 0.1); // æ¯å€‹ Combo åŠ  10%
                
                // 4. ç¸½åˆ†è¨ˆç®—
                roundScore = Math.round((basePoints + speedBonus) * streakMultiplier);
                
                totalScore += roundScore;
                correctCount++;

                // æ›´æ–° Combo UI (ç«ç†±æ•ˆæœ)
                els.combo.innerHTML = `<span class="text-orange-500 animate-pulse">ğŸ”¥ x${currentCombo}</span>`;
                els.combo.classList.add('scale-125');
            } else {
                // ç­”éŒ¯ï¼šCombo æ­¸é›¶ï¼Œæ²’åˆ†
                currentCombo = 0;
                roundScore = 0;
                els.combo.innerText = "x0";
                els.combo.classList.remove('scale-125');
            }

            // æ›´æ–°ç¸½åˆ† UI
            els.score.innerText = totalScore.toLocaleString();

            // é¡¯ç¤ºå›é¥‹è¦–çª—
            showFeedback(isCorrect, roundScore);

            // å»¶é²è·³è½‰ä¸‹ä¸€é¡Œ
            setTimeout(() => {
                els.feedback.classList.add('hidden');
                currentQIndex++;
                loadQuestion();
            }, 2000); // 2ç§’å¾Œä¸‹ä¸€é¡Œ
        }

        // === 5. é¡¯ç¤ºå›é¥‹è¦–çª— ===
        function showFeedback(isCorrect, scoreEarned) {
            const content = document.getElementById('feedback-content');
            els.feedback.classList.remove('hidden');
            
            if (isCorrect) {
                content.innerHTML = `
                    <div class="text-8xl mb-2">âœ…</div>
                    <div class="text-4xl font-black text-green-400 mb-2">CORRECT!</div>
                    <div class="text-xl text-white font-mono">+${scoreEarned} pts</div>
                    ${currentCombo > 1 ? `<div class="text-orange-400 font-bold mt-2 text-sm">é€£æ“Š x${currentCombo}</div>` : ''}
                `;
            } else {
                content.innerHTML = `
                    <div class="text-8xl mb-2">âŒ</div>
                    <div class="text-4xl font-black text-red-500 mb-2">WRONG!</div>
                    <div class="text-gray-400 text-sm">Combo Lost...</div>
                `;
            }
        }

        // === 6. éŠæˆ²çµæŸ ===
        async function finishGame() {
            els.game.classList.add('hidden');
            els.result.classList.remove('hidden');
            
            document.getElementById('final-score').innerText = totalScore.toLocaleString();
            document.getElementById('final-combo').innerText = maxCombo;
            
            const accuracy = Math.round((correctCount / questions.length) * 100);
            document.getElementById('final-accuracy').innerText = `${accuracy}%`;

            // ä¸Šå‚³æœ€çµ‚æˆç¸¾è‡³ Firestore
            try {
                await setDoc(doc(db, "players", currentUser.uid), {
                    name: currentUser.name,
                    org: currentUser.org,
                    score: totalScore,
                    maxCombo: maxCombo, // å¤šå­˜é€™å€‹ï¼Œæ–¹ä¾¿ä¸»æŒäººçœ‹èª°æ˜¯é€£æ“Šç‹
                    accuracy: accuracy,
                    status: "finished",
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error("Upload failed", e);
            }
        }
    </script>
</body>
</html>